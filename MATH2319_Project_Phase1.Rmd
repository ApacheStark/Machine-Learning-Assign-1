---
title: "MATH2319_Assignment_Part1"
author: "Samuel Holt (s3381728) and Margaret Cuddihy (s3608125)"
date: "28 April 2019"
output: 
   html_document:
      includes:
      in_header: header.html
      before_body: doc_prefix.html
      after_body: doc_suffix.html
      toc: true
      toc_depth: 3
      
---
# Introduction

#### The data set chosen for machine learning training is Google advertising data. 

The data set was made available on Kaggle as part of the MATH2319 competition and was accessed from the following link:
https://www.kaggle.com/c/machine-learning-battle-mlmath2319/data

#### Goal
By training a machine learning algorithm to the descriptive features in the dataset, the target feature, a revenue metric labelled as y, can be predicted. Hence, the purpose of training a machine learning algorithm is that Google will be able to better predict the advertising specifications that optimise returns on clicks and potentially improve revenue returns.

#### Description of the Data Set
The dataset instances are comprised of website traffic records from around the world. Descriptive features include:
<ul> <li>	companyId: - Company ID of record (categorical)
<li>	countryId: - Country ID of record (categorical)
<li>	deviceType: - Device type of record (categorical corresponding to desktop, mobile, tablet)
<li>	day: -Day of record (integer between 1 (oldest) and 30 for train, 31 and 35 (most recent) for test)
<li>	dow: - Day of week of the record (categorical)
<li>	price1, price2, price3: - Price combination for the record set by the company (numeric)
<li>	ad_area: - area of advertisement (normalized between 0 and 1)
<li>	ad_ratio: - ratio of advertisement's length to its width (normalized between 0 and 1)
<li>	requests, impression, cpc, ctr, viewability: - Various metrics related to the record (numeric)
<li>	ratio1 - ratio5: - Ratio characteristics related to the record (each normalized between 0 and 1)
<li>	y (target feature): - revenue-related metric (numeric)
The currency features are in US Dollars.

#### Structure of Phase 1
First, the data will be inspected, and any necessary pre-processing will be undertaken to ensure the data set is clean and ready for modelling.
1.	Data structure and dimensions will be determined
2.	Data will be checked for any missing or special values which will be appropriately imputed
3.	Data will be checked for outliers which will be handled as necessary
Second, the descriptive features of the data will be explored in order to identify significant relationships between features that will guide the machine learning modelling. For instance, descriptive features with strong correlation may be redundant to predictive modelling.
1.	Distribution of descriptive feature levels will be examined
2.	Correlation between descriptive features will be calculated
3.	Correlation between descriptive features and the target feature will be calculated
The aim of this is to identify the descriptive features most useful for predicting the target variable, the revenue metric y.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
```{r echo=TRUE}
 library(dplyr)
# library(tidyr)
 library(knitr)
# library(mlr)
# library(outliers)
library(ggplot2)
library(Hmisc)
library(corrplot)

```
# Reading and Inspecting the Data
```{r echo=TRUE}

advertising_train <- read.csv("~/Uni/Machine Learning/advertising_train.csv", header = TRUE, stringsAsFactors = FALSE)

head(advertising_train)
tail(advertising_train)
dim(advertising_train)
str(advertising_train)
names(advertising_train)
class(advertising_train)
```

## Target Feature
y: numeric revenue-related metric

## Unique Identifier
Case ID: categorical

## Descriptive Features
1. Company ID: categorical 
2. Country ID: categorical
3. Device Type: categorical (Corresponding to Desktop, Mobile, Table and unknown? Unique values = 1,2,3 and 5 )
4. Day: integer (Day 1 to Day 30 in training data)
5. DOW: categorical (day of the week)
6. Price 1 (numeric)
7. Price 2 (numeric)
8. Price 3 (numeric)
9. Ad Area (normalised between 1 and 0)
10. Ad Ratio (normalised between 1 and 0)
11. Requests (numeric)
12. Impression (numeric)
13. CPC (numeric)
14. CTR (numeric)
15. Viewability (numeric)
16. Ratio 1 (normalised between 1 and 0)
17. Ratio 2 (normalised between 1 and 0)
18. Ratio 3 (normalised between 1 and 0)
19. Ratio 4 (normalised between 1 and 0)
20. Ratio 5 (normalised between 1 and 0)

214,218 Instances

# Cleaning and Preparing Data

```{r echo=TRUE}
kable(summary(advertising_train))

advertising_train %>% group_by(ad_ratio) %>% dplyr::summarise(count=n())
```
## Transformation and Pre Processing

### Factorisation of Categorical Variables
```{r}
# case_id can be filtered
# company id
# country id
# deviceType
# day
for (i in 1:5) advertising_train[,i] <- factor(advertising_train[,i])
```

### Log Transform
The following function will log transform all integer and numeric data, also considers zero or negative values in the scale and adds a scalar value to the column before transformation if this parameter is met.
```{r}
# Make a copy of non-transformed
train <- advertising_train
# Create log trans function
log_trans <- function(x) {
  for (i in 1:ncol(x))  
  if (class(x[,i]) == 'integer' | class(x[,i]) == 'numeric') {
    if (min(x[,i]) <= 0) {
      x[,i] <- x[,i] + min(x[,i]) + 0.1
      x[,i] <- log(x[,i])
    } else {
    x[,i] <- log(x[,i])
    } 
  }
  return(x)
}
train_log <- log_trans(advertising_train)
```
## Special Values

### Missing
```{r}
which(is.na(advertising_train)) 

# No missing values detected
```

### Special
```{r include=FALSE}
# Check for special values
is.special <- function(x){
  if (is.numeric(x)) !is.finite(x)
}

sapply(advertising_train, is.special)

# No special values detected
```

## Outliers

### Univariate

```{r}
#Categorical Features 

#--------------------[Company]----------------------#

company <- advertising_train %>% 
    group_by(companyId) %>% 
    dplyr::summarise(count=n())

company %>% 
    ggplot(aes(x = companyId, y = count)) +
    geom_col()

#Not sure about this one, looks weird. Would like to do more of a bar plot but the no of observations makes it difficult. 
```
```{r}

#--------------------[Country]----------------------#

country <- advertising_train %>% 
    group_by(countryId) %>% 
    dplyr::summarise(count=n())

country %>% 
    ggplot(aes(x = countryId, y = count)) +
    geom_col()


#If only we knew...what the country IDs stood for!!!
```
```{r}
#--------------------[Device Type]----------------------#

device <- advertising_train %>% 
    group_by(deviceType) %>% 
    dplyr::summarise(count=n())

device %>% 
    ggplot(aes(x = deviceType, y = count)) +
    geom_col()

#My guess was that device type was like 1 = tablet, 2 = phone, 3 = computer but I'm not sure?
```
```{r}
#--------------------[Day of Week]----------------------#

day.of.week <- advertising_train %>% 
    group_by(dow) %>% 
    dplyr::summarise(count=n())

day.of.week %>% 
    ggplot(aes(x = dow, y = count)) +
    geom_col()

#Saturday and Sunday most number of records
```
```{r}
#--------------------[Day]----------------------#

day <- advertising_train %>% 
    group_by(day) %>% 
    dplyr::summarise(count=n())

day %>% 
    ggplot(aes(x = day, y = count)) +
    geom_col()

#Fairly uniform distribution, bit lower at start of training period
```
#Numeric Features
```{r}
#--------------------[Price 1]----------------------#


price1 <- advertising_train$price1
summary(price1)

advertising_train %>% 
    group_by(price1) %>% 
    dplyr::summarise(count=n())

hist(price1)
boxplot(price1)

#Vast majority is 0 - 0.01?? All the outliers...

price1_log <- train_log$price1
summary(price1_log)

train_log%>% 
    group_by(price1) %>% 
    dplyr::summarise(count=n())

hist(price1_log)
boxplot(price1_log)

par(mfrow = c(1,4))
hist(price1)
boxplot(price1)

hist(price1_log)
boxplot(price1_log)
```
```{r}
#--------------------[Price 2]----------------------#


price2 <- advertising_train$price2
summary(price2)

advertising_train %>% 
    group_by(price2) %>% 
    dplyr::summarise(count=n())

hist(price2)
boxplot(price2)

#Vast majority is 0
```
```{r}
#--------------------[Price 3]----------------------#

price3 <- advertising_train$price3
summary(price3)

advertising_train %>% 
    group_by(price3) %>% 
    dplyr::summarise(count=n())

hist(price3)
boxplot(price3)

#Vast majority is 0
```
```{r}
#--------------------[Ad Area]----------------------#


adar <- advertising_train$ad_area
summary(adar)

advertising_train %>% 
    group_by(ad_area) %>% 
    dplyr::summarise(count=n())

hist(adar)
boxplot(adar)

#Most instances of ad area are 0.0001., Max is 36 - thought this was normalised between 0 and 1?
```
```{r}
#--------------------[Ad Ratio]----------------------#


adra <- advertising_train$ad_ratio
summary(adra)

#Max is 5 and yet it's meant to be normalised between 0 and 1?

advertising_train %>% 
    group_by(ad_ratio) %>% 
    dplyr::summarise(count=n())

hist(adra)
boxplot(adra)

#Think we can play around with the binning for this maybe?
```
```{r}
#--------------------[Requests]----------------------#


reqs <- advertising_train$requests
summary(reqs)

advertising_train %>% 
    group_by(requests) %>% 
    dplyr::summarise(count=n())

hist(reqs)
boxplot(reqs)

#Oh lordy...
```
```{r}
#--------------------[Impression]----------------------#


imp <- advertising_train$impression
summary(imp)

advertising_train %>% 
    group_by(impression) %>% 
    dplyr::summarise(count=n())

hist(imp)
boxplot(imp)
```
```{r}
#--------------------[CPC - Cost per click]----------------------#


cpc <- advertising_train$cpc
summary(cpc)

advertising_train %>% 
    group_by(cpc) %>% 
    dplyr::summarise(count=n())

hist(cpc)
boxplot(cpc)
```
```{r}
#--------------------[CTR - click through rate]----------------------#


ctr <- advertising_train$ctr
summary(ctr)

advertising_train %>% 
    group_by(ctr) %>% 
    dplyr::summarise(count=n())

hist(ctr)
boxplot(ctr)

```
```{r}
#--------------------[Viewability]----------------------#


view <- advertising_train$viewability
summary(view)

advertising_train %>% 
    group_by(viewability) %>% 
    dplyr::summarise(count=n())

hist(view)
boxplot(view)

```
```{r}
#--------------------[Ratio 1]----------------------#

summary(advertising_train$ratio1)

advertising_train %>% 
    group_by(ratio1) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$ratio1)
boxplot(advertising_train$ratio1)
```
```{r}
#--------------------[Ratio 2]----------------------#

summary(advertising_train$ratio2)

advertising_train %>% 
    group_by(ratio2) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$ratio2)
boxplot(advertising_train$ratio2)
```
```{r}
#--------------------[Ratio 3]----------------------#

summary(advertising_train$ratio3)

advertising_train %>% 
    group_by(ratio3) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$ratio3)
boxplot(advertising_train$ratio3)
```
```{r}
#--------------------[Ratio 4]----------------------#

summary(advertising_train$ratio4)

advertising_train %>% 
    group_by(ratio4) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$ratio4)
boxplot(advertising_train$ratio4)
```
```{r}
#--------------------[Ratio 5]----------------------#

summary(advertising_train$ratio5)

advertising_train %>% 
    group_by(ratio5) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$ratio5)
boxplot(advertising_train$ratio5)

#Hmmm very interesting, if only we knew what these were ratios of!

```
```{r}
#--------------------[Target Variable (y)]----------------------#

summary(advertising_train$y)

advertising_train %>% 
    group_by(y) %>% 
    dplyr::summarise(count=n())

hist(advertising_train$y)
boxplot(advertising_train$y)

```

### Multivariate 
```{r}
y <- advertising_train$y

boxplot(y~advertising_train$companyId)

plot(y~advertising_train$countryId)

boxplot(y~advertising_train$deviceType)

plot(y~advertising_train$day)

boxplot(y~advertising_train$dow)

plot(y~advertising_train$price1)

plot(y~advertising_train$price2)

plot(y~advertising_train$price3)

plot(y~advertising_train$ad_ratio)

plot(y~advertising_train$ad_area)

plot(y~advertising_train$requests)

plot(y~advertising_train$impression)

plot(y~advertising_train$cpc)

plot(y~advertising_train$ctr)

plot(y~advertising_train$viewability)

plot(y~advertising_train$requests)

plot(y~advertising_train$ratio1)

plot(y~advertising_train$ratio2)

plot(y~advertising_train$ratio3)

plot(y~advertising_train$ratio4)

plot(y~advertising_train$ratio5)


```


# Visualisation

## Bivariate Visuals with Respect to Target Feature

### Prices
```{r}

#Calculate Average Price and Maximum Price
train1 <- train %>% mutate(avg_price = (price1*price2*price3)/3,
                           max_price = pmax(price1, price2, price3))

summary(train1$avg_price)
summary(train1$max_price)

par(mfrow = c(3,1))
plot(train1$avg_price, train1$y)
plot(train1$max_price, train1$y)
par(mfrow = c(1,1))

# Pre Log trans PRICE
par(mfrow = c(3,1))
plot(train$price1, train$y) # all pos skewed, majority at lower quartile of range, trace values at upper 3 quartiles
plot(train$price2, train$y)
plot(train$price3, train$y)
par(mfrow = c(1,1))
```
### Ratios
```{r}
# Pre Log trans RATIO
par(mfrow = c(1,5))
plot(train$ratio1, train$y) # majority of variation at 0 and 1 ratios 
plot(train$ratio2, train$y) # majority of variation at 0 and 1 ratios 
plot(train$ratio3, train$y) # majority of variation at 0 and 1 ratios, with some exceeding 1 
plot(train$ratio4, train$y) # majority of variation at 0 
plot(train$ratio5, train$y) # majority of variation at 0 and some at 1 ratios, with some exceeding 1
par(mfrow = c(1,1))
```

### CPC and CTR
Cost Per Click (also known as PPC, Pay Per Click) and Click Through Rate will be investigated for impact on each other and on the target variable.
```{r}
# COST PER CLICKS
# This is the advertising cost per click for given ad, as price goes up, the 'rank' of the ad decreases exponentially.
# Essentially, you want to minimise cost per click, which reflects your score, visa versa.
cpc_id_box <- boxplot(cpc ~ companyId, data = train)
cpc_filt <- train %>% select(companyId, cpc) %>%  filter(cpc > 0 & cpc < 1)
cpc_filt_box <- boxplot(cpc ~ companyId, data = cpc_filt) # company makes a difference
cpc_zero <- train %>% select(companyId, cpc) %>%  group_by(companyId) %>% filter(cpc == 0) %>%  summarise(ZeroVal = n())
cpc_more <- train %>% select(companyId, cpc) %>%  group_by(companyId) %>%  summarise(Total = n())
cpc_tbl <- cbind(cpc_zero, cpc_more[2]) %>%  as.tbl %>%  mutate(Ratio = ZeroVal / Total,
                                                                NonZero = Total - ZeroVal)
# RATIO OF ZERO CPC TO TOTAL
ggplot(data = cpc_tbl,
       mapping = aes(y = Ratio, x = companyId, fill = companyId)) +
  geom_bar(stat = 'identity', position = 'dodge') + 
  labs(title = 'Ratio of Zero Values against Total')
```
```{r}
# CLICK THROUGH RATE
# Perecentage of viewers on a web page who selected a hyperlink to a site
# CTR = (Total Measured Clicks/Total Measured Ad Impressions) * 100
# Clicks are per click, ad impression is the appearance of an ad (clicked or not)
ctr_id_box <- boxplot(ctr ~ companyId, data = train) 
ctr_filt <- train %>%  select(companyId, ctr) %>%  filter(ctr > 0)
ctr_filt_box <- boxplot(ctr ~ companyId, data = ctr_filt) # many 0 values for ID 43
ctr_zero <- train %>%  select(companyId, ctr) %>% group_by(companyId) %>% filter(ctr == 0) %>%  summarise(ZeroVal = n())
ctr_more <- train %>%  select(companyId, ctr) %>%  group_by(companyId) %>% summarise(Total = n())
ctr_tbl <- cbind(ctr_zero, ctr_more[2]) %>%  as.tbl %>%  mutate(Ratio = ZeroVal / Total,
                                                                NonZero = Total - ZeroVal)
# RATIO OF ZERO CTR TO TOTAL 
ggplot(data = ctr_tbl,
       mapping = aes(y = Ratio, x = companyId, fill = companyId)) +
  geom_bar(stat = 'identity', position = 'dodge') + 
  labs(title = 'Ratio of Zero Values against Total') # absolutely no difference to

# CPC against CTR
plot(cpc ~ ctr, data = train,
     ylab = 'Cost Per Click',
     xlab = 'Click Through Rate')
# CTR decreases to nothing, the less appealing the ad, the more likely the the advertiser is charged higher for the less appealing ad
```
```{r}
# Bivariate analysis of partitioned data with respect to Target Feature y
# CTR Summary
ctrzero_y <- train %>% select(companyId, ctr, y) %>%  filter(ctr == 0)
summary(ctrzero_y)
ctrmore_y <- train %>% select(companyId, ctr, y) %>%  filter(ctr > 0)
summary(ctrmore_y)
# all metrics (with exception of Max value) increase for y when looking at higher click through rates
# CPC Summary
cpczero_y <- train %>% select(companyId, cpc, y) %>%  filter(cpc == 0)
summary(cpczero_y)
cpcmore_y <- train %>%  select(companyId, cpc, y) %>% filter(cpc > 0)
summary(cpcmore_y)
# same results to CTR summary with rescpt to target feature y
```

# Statistical Investigation

## Linear Correlations
```{r}


#Calculate correlation of numeric variables:
train_num <- train %>% select(price1, price2, price3, ad_area, ad_ratio, requests, impression, cpc, ctr, viewability, ratio1, ratio2, ratio3, ratio4, ratio5)
res <- cor(train_num)
round(res, 2)

pairs(res) #crazy small

heatmap(res) #Looks cool but not sure if easy to interpret?

corrplot(res, order = "hclust", 
         tl.col = "black", tl.srt = 45)

#I like this one the best - can see there is positive correlation amongst price features
#Very Strong positive correlation between Impression and Request
#Very Strong positive correlation between Price 1, Price 2 and Price 3
#Very strong positive correlation between Ratio 1 and Viewability 
#Strong positive correlation between Ratio 2 and Viewability 
#Strong positive correlation between Ratio 1 and Ratio 2

train_price <- train %>% select(price1,price2,price3)
res_price <- cor(train_price)
round(res_price,2)

#Correlation between Price 1 and Price 2: 0.9
#Correlation between Price 2 and Price 3: 0.94
#Correlation between Price 3 and Price 1: 0.77

#Possibly only need 1 price variable for training the algorithm as correlation is very high

train_ratio <- train %>% select(ratio1, ratio2, ratio3, ratio4, ratio5)
res_ratio <- cor(train_ratio)
round(res_ratio,2)
corrplot(res_ratio, order = "hclust", 
         tl.col = "black", tl.srt = 45)

#Correlation between Ratio 1 and Ratio 2 is 0.84
#Correlation between Ratio 1 and Ratio 3 is 0.52
#Correlation between Ratio 2 and Ratio 5 is 0.48
#Correlation between Ratio 5 and Ratio 1 nis 0.45
#Correlation between Ratio 2 and Ratio 3 is 0.43
#All other ratio features have weaker correlation
#Ratio 3 is negatively correlated to Ratio 4 and Ratio 5, yet positively correlated to Ratio 1 and Ratio 2 (which are positively correlated to Ratio 4 and Ratio 5)

train_metrics <- train %>% select(ad_area, ad_ratio, requests, impression, cpc, ctr, viewability)
res_metrics <- cor(train_metrics)
round(res_metrics, 2)
corrplot(res_metrics, order = "hclust", 
         tl.col = "black", tl.srt = 45)

#Correlation between Impression and Requests is 0.98 
#Correlation between Viewability and CTR is 0.41
#All other metrics have weak correlation

res_y <- cor(train$y,train_num)
round(res_y, 3)

#None of the descriptive features are highly correlated with the target feature y. 


```
# Summary


